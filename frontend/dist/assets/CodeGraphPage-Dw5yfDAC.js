import{j as e,S as v,G as j,T as ie,b as l,y as Ce,B as N,l as we,d as ze,m as J,w as ve,g as F,L as Ne,s as Le,h as G,K as R,k as ne}from"./mantine-CZuIZRc1.js";import{r as h}from"./react-core-odM0sU5y.js";import{u as Ee}from"./queries-6Rqy06Fp.js";import{c as oe}from"./api-J5tP0VF3.js";import{u as Se}from"./v2-store-DFm9FS0q.js";import{u as Ie,e as ke,f as ae,M as Te,g as Me,h as Ae,i as Ge,j as He}from"./charts-BUPZVE1m.js";import{H as Q,J as Pe,K as De,L as Oe,i as Be,I as le,M as Re,N as We,O as Fe,P as _e}from"./icons-D07X1pjv.js";import"./index-CkX9QzOI.js";import"./routing-CXNmw2WA.js";const A={class:"#3b82f6",interface:"#a855f7",enum:"#f97316",function:"#22c55e",variable:"#6b7280",critical:"#ef4444",high:"#f97316",medium:"#eab308",low:"#22c55e"};function qe({data:o,selected:x}){var E;const z=A[o.type]||A.class,L=o.impactLevel?A[o.impactLevel]:void 0;return e.jsxs("div",{className:`custom-node ${x?"selected":""} ${o.isAffected?"affected":""}`,style:{padding:"12px 16px",borderRadius:"8px",border:`2px solid ${x?z:"#e5e7eb"}`,borderLeft:`4px solid ${o.isAffected?L||A.critical:z}`,backgroundColor:"white",minWidth:"180px",maxWidth:"240px",boxShadow:o.isAffected?"0 4px 12px rgba(239, 68, 68, 0.3)":"0 2px 4px rgba(0,0,0,0.1)"},children:[e.jsxs(j,{gap:8,mb:o.complexity?8:0,children:[e.jsx("div",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:z}}),e.jsx(l,{fw:600,size:"sm",lineClamp:1,children:o.label}),o.isAffected&&e.jsx(G,{color:L||"red",size:"xs",variant:"filled",children:"Impact"})]}),e.jsxs(j,{gap:4,children:[e.jsx(G,{size:"xs",variant:"light",c:z,children:o.type}),o.complexity!==void 0&&e.jsx(F,{label:"Cyclomatic Complexity",children:e.jsxs(G,{size:"xs",color:o.complexity>15?"red":o.complexity>10?"yellow":"green",children:["C: ",o.complexity]})})]}),e.jsx(l,{size:"xs",c:"dimmed",mt:8,lineClamp:1,children:o.filePath.split("/").slice(-2).join("/")}),((E=o.metadata)==null?void 0:E.linesOfCode)!=null&&e.jsxs(l,{size:"xs",c:"dimmed",children:[Number(o.metadata.linesOfCode)," LOC"]})]})}const Ve={custom:qe};function ts({projectId:o}){var se,te;const{codeGraphData:x,setCodeGraphData:z,isCodeGraphLoading:L,setIsCodeGraphLoading:E,selectedGraphNode:H,setSelectedGraphNode:_}=Se(),[T,P,re]=Ie([]),[D,O,ce]=ke([]),[a,q]=h.useState(null),[S,de]=h.useState(""),[V,he]=h.useState("dagre"),{data:B,isLoading:U,refetch:X}=Ee({queryKey:["codeGraph",o],queryFn:()=>oe.analyze(o||1),enabled:!!o});h.useMemo(()=>{B&&(z(B),xe(B))},[B]);const xe=h.useCallback(s=>{const n=s.nodes.map(i=>({id:i.id,type:"custom",position:{x:0,y:0},data:{label:i.name,type:i.type,filePath:i.filePath,complexity:i.complexity,dependencies:i.dependencies,dependents:i.dependents,metadata:i.metadata,isAffected:!1,impactLevel:void 0},sourcePosition:ae.Right,targetPosition:ae.Left})),d=s.edges.map(i=>({id:i.id,source:i.source,target:i.target,type:"smoothstep",animated:i.type==="implements",style:{stroke:ee(i.type),strokeWidth:i.weight?Math.min(4,1+i.weight):2},markerEnd:{type:Te.ArrowClosed,color:ee(i.type)},label:i.label,labelStyle:{fontSize:10,fontWeight:600}})),{nodes:b,edges:u}=ue(n,d,V);P(b),O(u)},[V,P,O]),ue=h.useCallback((s,n,d)=>d==="force"?me(s,n):pe(s,n,d==="hierarchical"),[]),pe=h.useCallback((s,n,d)=>{const b=new Map(s.map(t=>[t.id,t])),u=new Map,i=new Map;s.forEach(t=>{u.set(t.id,0),i.set(t.id,[])}),n.forEach(t=>{var f;(f=i.get(t.source))==null||f.push(t.target),u.set(t.target,(u.get(t.target)||0)+1)});const I=[],m=new Set,p=s.filter(t=>(u.get(t.id)||0)===0).map(t=>t.id);for(;p.length>0;){const t=[...p];I.push(t),p.length=0,t.forEach(f=>{var K;m.add(f),(K=i.get(f))==null||K.forEach(k=>{m.has(k)||(u.set(k,(u.get(k)||0)-1),(u.get(k)||0)===0&&p.push(k))})})}s.forEach(t=>{m.has(t.id)||I.push([t.id])});const c=200,C=120,w=80,g=100;return{nodes:s.map(t=>{const f=I.findIndex(M=>M.includes(t.id)),be=(I[f]||[]).map(M=>b.get(M)).filter(Boolean).findIndex(M=>M.id===t.id);return{...t,position:{x:be*(c+w)+50,y:f*(C+g)+50}}}),edges:n}},[]),me=h.useCallback((s,n)=>{const i=new Map;s.forEach(m=>{i.set(m.id,{x:Math.random()*2e3,y:Math.random()*1500})});for(let m=0;m<100;m++)s.forEach(p=>{const c=i.get(p.id);s.forEach(C=>{if(p.id===C.id)return;const w=i.get(C.id),g=c.x-w.x,y=c.y-w.y,t=Math.sqrt(g*g+y*y)||1,f=500/(t*t);c.x+=g/t*f,c.y+=y/t*f})}),n.forEach(p=>{const c=i.get(p.source),C=i.get(p.target),w=C.x-c.x,g=C.y-c.y,y=Math.sqrt(w*w+g*g)||1,t=(y-150)*.05;c.x+=w/y*t,c.y+=g/y*t,C.x-=w/y*t,C.y-=g/y*t}),s.forEach(p=>{const c=i.get(p.id);c.x+=(2e3/2-c.x)*.01,c.y+=(1500/2-c.y)*.01});return{nodes:s.map(m=>({...m,position:i.get(m.id)||{x:0,y:0}})),edges:n}},[]),fe=h.useCallback(s=>O(n=>Me(s,n)),[O]),je=h.useCallback((s,n)=>{const d=x==null?void 0:x.nodes.find(b=>b.id===n.id);d&&(q(d),_(n.id))},[x,_]),Y=h.useCallback(async()=>{if(!(!H||!o)){E(!0);try{const s=await oe.getBlastRadius(o,H);P(n=>n.map(d=>{const b=s.affectedNodes.find(u=>u.nodeId===d.id);return b?{...d,data:{...d.data,isAffected:!0,impactLevel:ge(b.distance||0)}}:d}))}catch{console.error("Failed to calculate blast radius")}finally{E(!1)}}},[H,o,E,P]),ge=s=>s===0?"critical":s===1?"high":s===2?"medium":"low",ee=s=>{switch(s){case"depends_on":return"#94a3b8";case"used_by":return"#22c55e";case"implements":return"#a855f7";case"extends":return"#3b82f6";default:return"#64748b"}},Z=h.useMemo(()=>{if(!S)return T;const s=S.toLowerCase();return T.filter(n=>n.data.label.toLowerCase().includes(s)||n.data.filePath.toLowerCase().includes(s))},[T,S]),ye=h.useMemo(()=>{if(!S)return D;const s=new Set(Z.map(n=>n.id));return D.filter(n=>s.has(n.source)&&s.has(n.target))},[D,Z,S]),r=x==null?void 0:x.metrics,$=r?Math.round(r.avgComplexity):0;return e.jsxs(v,{gap:"md",children:[e.jsxs(j,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(ie,{order:2,children:"Code Graph Visualizer"}),e.jsx(l,{c:"dimmed",children:"Visualize e analise dependências do código"})]}),e.jsxs(j,{children:[e.jsx(Ce,{value:V,onChange:s=>he(s),data:[{value:"dagre",label:"Hierárquico"},{value:"force",label:"Force-Directed"}],leftSection:e.jsx(Q,{size:16})}),e.jsx(N,{leftSection:e.jsx(Pe,{size:16}),onClick:()=>X(),variant:"light",loading:U,children:"Recarregar"})]})]}),e.jsxs(we,{cols:{base:2,md:4},children:[e.jsx(W,{label:"Total Nodes",value:(r==null?void 0:r.totalNodes)||T.length,icon:e.jsx(De,{size:18})}),e.jsx(W,{label:"Total Edges",value:(r==null?void 0:r.totalEdges)||D.length,icon:e.jsx(Oe,{size:18})}),e.jsx(W,{label:"Complexidade Média",value:$,icon:e.jsx(Be,{size:18}),color:$>15?"red":$>10?"yellow":"green"}),e.jsx(W,{label:"Ciclos Detectados",value:((se=r==null?void 0:r.circularDependencies)==null?void 0:se.length)||0,icon:e.jsx(le,{size:18}),color:(((te=r==null?void 0:r.circularDependencies)==null?void 0:te.length)||0)>0?"red":"green"})]}),r&&r.circularDependencies.length>0&&e.jsxs(ze,{color:"red",icon:e.jsx(le,{size:18}),children:[e.jsx(l,{fw:600,children:"Dependências Circulares Detectadas"}),e.jsxs(l,{size:"sm",children:[r.circularDependencies.length," ciclos encontrados"]})]}),e.jsx(J,{padding:"sm",withBorder:!0,children:e.jsxs(j,{justify:"space-between",children:[e.jsxs(j,{children:[e.jsx(ve,{placeholder:"Buscar nó...",leftSection:e.jsx(Re,{size:16}),value:S,onChange:s=>de(s.currentTarget.value),w:250}),H&&e.jsx(N,{variant:"light",size:"sm",onClick:Y,leftSection:e.jsx(Q,{size:16}),children:"Calcular Impacto"})]}),e.jsxs(j,{children:[e.jsx(F,{label:"Zoom In",children:e.jsx(N,{variant:"subtle",size:"sm",children:e.jsx(We,{size:18})})}),e.jsx(F,{label:"Zoom Out",children:e.jsx(N,{variant:"subtle",size:"sm",children:e.jsx(Fe,{size:18})})}),e.jsx(F,{label:"Fit View",children:e.jsx(N,{variant:"subtle",size:"sm",children:e.jsx(_e,{size:18})})})]})]})}),e.jsx(J,{padding:0,withBorder:!0,style:{height:"600px"},children:U||L?e.jsxs(v,{align:"center",justify:"center",h:"100%",children:[e.jsx(Ne,{size:"lg"}),e.jsx(l,{c:"dimmed",children:"Analisando código..."})]}):T.length===0?e.jsxs(v,{align:"center",justify:"center",h:"100%",children:[e.jsx(Q,{size:48,style:{color:"var(--mantine-color-dimmed)"}}),e.jsx(l,{c:"dimmed",children:"Nenhum dado de grafo disponível"}),e.jsx(N,{onClick:()=>X(),children:"Analisar Código"})]}):e.jsxs(Ae,{nodes:Z,edges:ye,onNodesChange:re,onEdgesChange:ce,onConnect:fe,onNodeClick:je,nodeTypes:Ve,fitView:!0,minZoom:.2,maxZoom:2,defaultEdgeOptions:{animated:!1,style:{stroke:"#94a3b8",strokeWidth:2}},children:[e.jsx(Ge,{}),e.jsx(He,{})]})}),e.jsx(Le,{opened:!!a,onClose:()=>q(null),title:e.jsx(ie,{order:4,children:a==null?void 0:a.name}),size:"lg",children:a&&e.jsxs(v,{gap:"md",children:[e.jsxs(j,{children:[e.jsx(G,{color:A[a.type],children:a.type}),a.complexity!==void 0&&e.jsxs(G,{color:a.complexity>15?"red":a.complexity>10?"yellow":"green",children:["Complexidade: ",a.complexity]})]}),e.jsx(R,{label:"Localização",labelPosition:"left"}),e.jsx(l,{size:"sm",c:"dimmed",children:a.filePath}),a.startLine&&a.endLine&&e.jsxs(l,{size:"sm",children:["Linhas: ",a.startLine," - ",a.endLine]}),e.jsx(R,{label:"Dependências",labelPosition:"left"}),e.jsx(ne,{h:100,children:e.jsx(v,{gap:4,children:a.dependencies.length===0?e.jsx(l,{c:"dimmed",children:"Nenhuma dependência"}):a.dependencies.map(s=>e.jsx(l,{size:"sm",children:s},s))})}),e.jsx(R,{label:"Dependentes",labelPosition:"left"}),e.jsx(ne,{h:100,children:e.jsx(v,{gap:4,children:a.dependents.length===0?e.jsx(l,{c:"dimmed",children:"Nenhum dependente"}):a.dependents.map(s=>e.jsx(l,{size:"sm",children:s},s))})}),a.metadata&&Object.keys(a.metadata).length>0&&e.jsxs(e.Fragment,{children:[e.jsx(R,{label:"Metadata",labelPosition:"left"}),e.jsx(v,{gap:4,children:Object.entries(a.metadata).map(([s,n])=>e.jsxs(j,{justify:"space-between",children:[e.jsx(l,{size:"sm",fw:600,children:s}),e.jsx(l,{size:"sm",children:String(n)})]},s))})]}),e.jsx(j,{children:e.jsx(N,{fullWidth:!0,onClick:()=>{_(a.id),Y(),q(null)},children:"Ver Impacto"})})]})})]})}function W({label:o,value:x,icon:z,color:L="blue"}){return e.jsx(J,{padding:"md",withBorder:!0,children:e.jsxs(j,{gap:"sm",children:[e.jsx("div",{style:{color:L},className:"metric-icon",children:z}),e.jsxs("div",{children:[e.jsx(l,{size:"xs",c:"dimmed",children:o}),e.jsx(l,{fz:"lg",fw:700,children:x})]})]})})}export{ts as CodeGraphPage};
