import{j as e,S as m,G as a,T,b as r,y as ae,l as H,m as D,h as y,k as K,L as le,q as z,g as J,B as l,s as oe,O as ce}from"./mantine-CZuIZRc1.js";import{r as c}from"./react-core-odM0sU5y.js";import{a as de,u as xe,b as E}from"./queries-6Rqy06Fp.js";import{b as w,s as ue}from"./api-J5tP0VF3.js";import{u as je}from"./v2-store-DFm9FS0q.js";import{D as pe}from"./diff-DlsCkgVA.js";import{E as he,a as k,Q as B,d as A,C as me,x as ge,R as fe,S as Ce,T as ye,U as X}from"./icons-D07X1pjv.js";import"./index-CkX9QzOI.js";import"./routing-CXNmw2WA.js";import"./charts-BUPZVE1m.js";function Ie({reviewId:t}){var U;const j=de(),{fixSuggestions:g,setFixSuggestions:f,selectedFixSuggestion:o,setSelectedFixSuggestion:p,isApplyingFix:I,setIsApplyingFix:v}=je(),[h,S]=c.useState(""),[F,n]=c.useState(!1),[N,$]=c.useState("split"),[d,W]=c.useState(null),{data:b,isLoading:Y}=xe({queryKey:["fixSuggestions",t],queryFn:()=>w.listByReview(t||0),enabled:!!t});c.useEffect(()=>{b&&f(b)},[b,f]);const V=E({mutationFn:s=>w.applyFix(s),onMutate:()=>{v(!0)},onSuccess:()=>{v(!1),j.invalidateQueries({queryKey:["fixSuggestions"]})},onError:()=>{v(!1)}}),L=E({mutationFn:({suggestionId:s,reviewedBy:u})=>w.approveSuggestion(s,u),onSuccess:()=>{j.invalidateQueries({queryKey:["fixSuggestions"]})}}),M=E({mutationFn:({suggestionId:s,reviewedBy:u,reason:C})=>w.rejectSuggestion(s,u,C),onSuccess:()=>{n(!1),S(""),j.invalidateQueries({queryKey:["fixSuggestions"]})}}),P=E({mutationFn:({originalCode:s,fixedCode:u,language:C})=>ue.validateFix(s,u,C),onSuccess:s=>{W(s)}}),Z=s=>{switch(s){case"PENDING":return"yellow";case"APPROVED":return"blue";case"APPLIED":return"green";case"REJECTED":return"red";case"FAILED":return"red";case"EXPIRED":return"gray";default:return"gray"}},_=s=>{switch(s){case"HIGH":return"green";case"MEDIUM":return"yellow";case"LOW":return"red";default:return"gray"}},O=c.useCallback(s=>{p(s),V.mutate(s.id)},[V,p]),G=c.useCallback(s=>{L.mutate({suggestionId:s.id,reviewedBy:"current-user"})},[L]),q=c.useCallback(s=>{p(s),n(!0)},[p]),ee=c.useCallback(()=>{o&&h&&M.mutate({suggestionId:o.id,reviewedBy:"current-user",reason:h})},[o,h,M]),Q=c.useCallback(s=>{if(!s.originalCode||!s.fixedCode)return;const u=se(s.filePath);P.mutate({originalCode:s.originalCode,fixedCode:s.fixedCode,language:u})},[P]),se=s=>{var C;if(!s)return"text";switch((C=s.split(".").pop())==null?void 0:C.toLowerCase()){case"java":return"java";case"ts":return"typescript";case"js":return"javascript";case"py":return"python";case"go":return"go";default:return"text"}},x=g.length>0?g:b||[],ie=x.filter(s=>s.status==="PENDING"),re=x.filter(s=>s.status==="APPROVED"),te=x.filter(s=>s.status==="APPLIED"),ne=x.filter(s=>s.status==="REJECTED"),i=o||x[0];return e.jsxs(m,{gap:"md",children:[e.jsxs(a,{justify:"space-between",children:[e.jsxs("div",{children:[e.jsx(T,{order:2,children:"Auto-Fix"}),e.jsx(r,{c:"dimmed",children:"Sugestões de correção automática para issues"})]}),e.jsx(a,{children:e.jsx(ae,{placeholder:"Visualização",value:N,onChange:s=>$(s),data:[{value:"split",label:"Split View"},{value:"unified",label:"Unified View"}]})})]}),e.jsxs(H,{cols:{base:2,md:4},children:[e.jsx(R,{label:"Pendentes",value:ie.length,color:"yellow",icon:e.jsx(he,{size:20})}),e.jsx(R,{label:"Aprovados",value:re.length,color:"blue",icon:e.jsx(k,{size:20})}),e.jsx(R,{label:"Aplicados",value:te.length,color:"green",icon:e.jsx(B,{size:20})}),e.jsx(R,{label:"Rejeitados",value:ne.length,color:"red",icon:e.jsx(A,{size:20})})]}),e.jsxs(H,{cols:{base:1,lg:3},children:[e.jsxs(D,{padding:"md",withBorder:!0,h:700,children:[e.jsxs(a,{justify:"space-between",mb:"md",children:[e.jsx(T,{order:5,children:"Sugestões"}),e.jsx(y,{children:x.length})]}),e.jsx(K,{h:600,children:e.jsx(m,{gap:"sm",children:Y?e.jsxs(m,{align:"center",py:"xl",children:[e.jsx(le,{size:"sm"}),e.jsx(r,{size:"sm",c:"dimmed",children:"Carregando..."})]}):x.length===0?e.jsx(r,{c:"dimmed",ta:"center",py:"xl",children:"Nenhuma sugestão disponível"}):x.map(s=>e.jsx(ve,{suggestion:s,isSelected:(o==null?void 0:o.id)===s.id,onClick:()=>p(s),onApply:()=>O(s),onApprove:()=>G(s),onReject:()=>q(s),onValidate:()=>Q(s),isValidating:P.isPending,isApplying:V.isPending},s.id))})})]}),e.jsx(D,{padding:"0",withBorder:!0,h:700,children:i?e.jsxs(m,{h:"100%",children:[e.jsxs(z,{p:"md",bg:"dark.0",children:[e.jsxs(a,{justify:"space-between",children:[e.jsxs(a,{children:[e.jsx(y,{color:Z(i.status),children:i.status}),e.jsxs(y,{color:_(i.confidence),children:["Confiança: ",i.confidence]}),i.modelUsed&&e.jsx(y,{variant:"light",leftSection:e.jsx(ge,{size:12}),children:i.modelUsed})]}),e.jsxs(a,{gap:"xs",children:[e.jsx(J,{label:"Copiar código",children:e.jsx(l,{variant:"subtle",size:"xs",children:e.jsx(fe,{size:16})})}),e.jsx(J,{label:"Baixar patch",children:e.jsx(l,{variant:"subtle",size:"xs",children:e.jsx(Ce,{size:16})})})]})]}),i.filePath&&e.jsxs(r,{size:"sm",c:"dimmed",mt:"sm",children:[i.filePath,i.startLine&&`:${i.startLine}`,i.endLine&&`-${i.endLine}`]}),i.explanation&&e.jsxs(z,{mt:"sm",p:"sm",style:{backgroundColor:"var(--mantine-color-dark-1)",borderRadius:"4px"},children:[e.jsxs(a,{gap:"sm",children:[e.jsx(ye,{size:16}),e.jsx(r,{size:"sm",fw:600,children:"Explicação"})]}),e.jsx(r,{size:"sm",mt:"xs",children:i.explanation})]}),i.inputTokens&&e.jsxs(a,{gap:"xl",mt:"sm",children:[e.jsxs(r,{size:"xs",c:"dimmed",children:["Input: ",i.inputTokens.toLocaleString()," tokens"]}),e.jsxs(r,{size:"xs",c:"dimmed",children:["Output: ",((U=i.outputTokens)==null?void 0:U.toLocaleString())||0," tokens"]}),e.jsxs(r,{size:"xs",c:"dimmed",children:["Custo: $",(i.estimatedCost||0).toFixed(4)]})]}),e.jsxs(a,{mt:"md",children:[i.status==="PENDING"&&e.jsxs(e.Fragment,{children:[e.jsx(l,{size:"sm",leftSection:e.jsx(k,{size:16}),onClick:()=>G(i),loading:L.isPending,children:"Aprovar"}),e.jsx(l,{size:"sm",variant:"light",color:"red",leftSection:e.jsx(A,{size:16}),onClick:()=>q(i),children:"Rejeitar"})]}),i.status==="APPROVED"&&e.jsx(l,{size:"sm",leftSection:e.jsx(B,{size:16}),onClick:()=>O(i),loading:I,children:"Aplicar Correção"}),e.jsx(l,{size:"sm",variant:"light",leftSection:e.jsx(X,{size:16}),onClick:()=>Q(i),loading:P.isPending,children:"Validar"})]})]}),e.jsx(K,{flex:1,children:e.jsxs(z,{p:"md",children:[i.originalCode&&i.fixedCode?e.jsx(pe,{oldValue:i.originalCode,newValue:i.fixedCode,splitView:N==="split",useDarkTheme:!1}):e.jsx(z,{p:"md",style:{backgroundColor:"var(--mantine-color-yellow-0)",borderRadius:"4px"},children:e.jsx(r,{size:"sm",children:"Código não disponível para comparação"})}),d&&e.jsxs(z,{mt:"md",p:"md",style:{backgroundColor:d.success?"var(--mantine-color-green-0)":"var(--mantine-color-red-0)",borderRadius:"4px"},children:[e.jsxs(a,{gap:"sm",children:[d.success?e.jsx(k,{size:16}):e.jsx(A,{size:16}),e.jsx(r,{fw:600,children:"Resultado da Validação"})]}),e.jsx(r,{size:"sm",mt:"xs",children:d.output}),d.error&&e.jsx(r,{size:"sm",c:"red",children:d.error}),e.jsxs(r,{size:"xs",c:"dimmed",mt:"sm",children:["Tempo: ",d.durationMs,"ms | Exit Code: ",d.exitCode]})]})]})})]}):e.jsxs(m,{align:"center",justify:"center",h:"100%",children:[e.jsx(me,{size:48,style:{color:"var(--mantine-color-dimmed)"}}),e.jsx(r,{c:"dimmed",children:"Selecione uma sugestão para ver o diff"})]})})]}),e.jsx(oe,{opened:F,onClose:()=>n(!1),title:e.jsx(T,{order:4,children:"Rejeitar Sugestão"}),size:"md",centered:!0,children:e.jsxs(m,{gap:"md",children:[e.jsx(r,{size:"sm",children:"Por favor, forneça uma razão para rejeitar esta sugestão de correção."}),e.jsx(ce,{placeholder:"Descreva o motivo da rejeição...",value:h,onChange:s=>S(s.currentTarget.value),minRows:3,required:!0}),e.jsxs(a,{justify:"flex-end",children:[e.jsx(l,{variant:"light",onClick:()=>n(!1),children:"Cancelar"}),e.jsx(l,{color:"red",onClick:ee,disabled:!h.trim(),loading:M.isPending,children:"Rejeitar"})]})]})})]})}function R({label:t,value:j,icon:g,color:f="blue"}){const o={blue:"#3b82f6",cyan:"#06b6d4",purple:"#a855f7",green:"#22c55e",red:"#ef4444",yellow:"#eab308"};return e.jsx(D,{padding:"md",withBorder:!0,children:e.jsxs(a,{children:[e.jsx("div",{style:{color:o[f]},children:g}),e.jsxs("div",{children:[e.jsx(r,{size:"xs",c:"dimmed",children:t}),e.jsx(r,{fz:"xl",fw:700,children:j})]})]})})}function ve({suggestion:t,isSelected:j,onClick:g,onApply:f,onApprove:o,onReject:p,onValidate:I,isValidating:v,isApplying:h}){const S=n=>{switch(n){case"PENDING":return"yellow";case"APPROVED":return"blue";case"APPLIED":return"green";case"REJECTED":return"red";case"FAILED":return"red";case"EXPIRED":return"gray";default:return"gray"}},F=n=>{switch(n){case"HIGH":return"green";case"MEDIUM":return"yellow";case"LOW":return"red";default:return"gray"}};return e.jsx(D,{padding:"sm",withBorder:!0,style:{borderColor:j?"var(--mantine-color-blue-5)":void 0,cursor:"pointer"},onClick:g,children:e.jsxs(m,{gap:"xs",children:[e.jsxs(a,{justify:"space-between",children:[e.jsxs(a,{gap:4,children:[e.jsx(y,{size:"xs",color:S(t.status),children:t.status}),e.jsx(y,{size:"xs",color:F(t.confidence),children:t.confidence})]}),e.jsxs(r,{size:"xs",c:"dimmed",children:["#",t.id]})]}),t.filePath&&e.jsx(r,{size:"xs",c:"dimmed",lineClamp:1,children:t.filePath.split("/").slice(-2).join("/")}),t.explanation&&e.jsx(r,{size:"xs",lineClamp:2,children:t.explanation}),e.jsxs(a,{gap:4,children:[t.status==="PENDING"&&e.jsxs(e.Fragment,{children:[e.jsx(l,{size:"xs",variant:"light",leftSection:e.jsx(k,{size:14}),onClick:n=>{n.stopPropagation(),o()},children:"Aprovar"}),e.jsx(l,{size:"xs",variant:"light",color:"red",leftSection:e.jsx(A,{size:14}),onClick:n=>{n.stopPropagation(),p()},children:"Rejeitar"})]}),t.status==="APPROVED"&&e.jsx(l,{size:"xs",variant:"light",leftSection:e.jsx(B,{size:14}),onClick:n=>{n.stopPropagation(),f()},loading:h,children:"Aplicar"}),e.jsx(l,{size:"xs",variant:"subtle",leftSection:e.jsx(X,{size:14}),onClick:n=>{n.stopPropagation(),I()},loading:v,children:"Validar"})]})]})})}export{Ie as AutoFixPage};
